<!DOCTYPE html>
<meta charset="UTF-8"> 
<html>
<canvas id="canvas"></canvas>
<head>
<script>

var patternName = 'easy-4';
bpm = 60;
player = 'john';
deltas = [0,1000,1000,1000];
deltas_len = deltas.length;
idx = 0;
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");

function changePattern(form) {
    	patternName = form.name.value;
	console.log("name: "+patternName);

 	oReq = new XMLHttpRequest();
	oReq.addEventListener("load", 
		function () {
			idx = 0;
			deltas = JSON.parse(oReq.responseText)['deltas'];
			deltas_len = deltas.length;
		});
	oReq.open("GET", "/pattern/"+patternName+"/"+bpm);
	oReq.send();
	return false;
}

function post(path, params, method) {
    method = method || "post"; // Set method to post by default if not specified.
    var form = document.createElement("form");
    form.setAttribute("method", method);
    form.setAttribute("action", path);
    for(var key in params) {
        if(params.hasOwnProperty(key)) {
            var hiddenField = document.createElement("input");
            hiddenField.setAttribute("type", "hidden");
            hiddenField.setAttribute("name", key);
            hiddenField.setAttribute("value", params[key]);

            form.appendChild(hiddenField);
         }
    }

    document.body.appendChild(form);
    form.submit();
}

var accTime = 0
function playNote() {
	if (idx >= deltas_len) {
		//post('http://127.0.0.1:5000/foo', {foo: 'bar'});
		setTimeout(start, deltas[idx-1]);
		return;
	}
	var offset = (deltas[idx] + accTime) / 20;
	ctx.moveTo(offset, 100);
	ctx.lineTo(offset, 200);
	ctx.stroke();
	accTime += deltas[idx];
	setTimeout(playNote, deltas[++idx]);
}
function start() {
	idx = 0;
	accTime = 0;
	ctx.beginPath();
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	setTimeout(playNote, deltas[idx]);
}
window.addEventListener("keydown", dealWithKeyboard, false);

function end() {
	var obj = {};
	obj.pattern_name='easy-4';
	obj.player='john';
	obj.bpm=60;
	obj.tss=user_notes;
	post('/attempt', obj);
	console.log('post to server: ' +  user_notes);
}
user_notes = [] 
init = 0;
function dealWithKeyboard(e) {
	console.log('code: ' + e.keyCode);
	//if !(e.keyCode === 0 || e.keyCode === 32)
	if (e.keyCode != 32)
		return;
	if (init == 0) {
		init = 1;
		base = new Date().getTime();
		setTimeout(end, 3400);
	}
	ts = new Date().getTime();
	user_notes.push(ts - base)
	console.log('ts: ' +  ts);
}
function showPatterns() {
 	oReq = new XMLHttpRequest();
	oReq.addEventListener("load", 
		function () {
			patterns = JSON.parse(oReq.responseText)['patterns'];
			document.getElementById('out').innerHTML = patterns;
		});
	oReq.open("GET", "/pattern");
	oReq.send();
}
showPatterns();
</script>
</head>

<body onload="start()">
<form name="myform" action="" method="get">choose a pattern: <br>
<input type="text" name="name" value=""><p>
<input type="button" name="button" value="click" onClick="changePattern(this.form)">
</form>
<br>
available patterns: 
<div id="out"></div>
</body>
</html>

